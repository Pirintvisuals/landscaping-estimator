import { useState, useEffect, useRef } from 'react'
import {
  createInitialState,
  updateStateWithExtraction,
  getNextQuestion,
  generateAcknowledgment,
  isReadyForEstimate,
  detectCurrentField,
  isRelevantFieldExtracted,
  incrementRetryCount,
  resetRetryCount,
  type ChatMessage,
  type ConversationState,
  type ExtractedInfo
} from './conversationManager'
import { getFallbackQuickReplies, type QuickReply } from './quickReplies'
import {
  calculateUKEstimate,
  formatCurrencyGBP,
  type EstimateResult,
  type ProjectInputs
} from './qouter'

function App() {
  const [state, setState] = useState<ConversationState>(createInitialState())
  const [input, setInput] = useState('')
  const [isProcessing, setIsProcessing] = useState(false)
  const [estimate, setEstimate] = useState<EstimateResult | null>(null)
  const [quickReplies, setQuickReplies] = useState<QuickReply[]>([])
  const messagesEndRef = useRef<HTMLDivElement>(null)

  // Auto-scroll to bottom when new messages appear
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [state.messageHistory])

  // Send initial greeting on mount
  useEffect(() => {
    const greeting: ChatMessage = {
      id: crypto.randomUUID(),
      role: 'agent',
      content: "Hi! I'm your landscaping assistant. What kind of outdoor transformation are you thinking about?",
      timestamp: new Date()
    }

    setState(prev => ({
      ...prev,
      messageHistory: [greeting]
    }))
  }, [])

  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!input.trim() || isProcessing) return

    const userMessage: ChatMessage = {
      id: crypto.randomUUID(),
      role: 'user',
      content: input.trim(),
      timestamp: new Date()
    }

    // Add user message to state immediately
    setState(prev => ({
      ...prev,
      messageHistory: [...prev.messageHistory, userMessage]
    }))

    setInput('')
    setIsProcessing(true)

    try {
      let extracted: ExtractedInfo = {}

      // Try API first (online mode with Gemini AI)
      try {
        const response = await fetch('/api/conversation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userMessage: userMessage.content,
            conversationState: state
          })
        })

        if (response.ok) {
          const data = await response.json()
          extracted = data.extracted || {}
          console.log('‚úÖ Using online mode (Gemini API)')
        } else {
          throw new Error('API not available')
        }
      } catch (apiError) {
        // Fallback to local extraction (offline mode)
        console.log('‚ö° Using offline mode (local extraction)')
        const { extractLocalInformation } = await import('./localExtraction')
        extracted = extractLocalInformation(userMessage.content)
      }

      // Update state with extracted information
      const updatedState = updateStateWithExtraction(state, extracted)

      // RETRY DETECTION: Check if extraction was successful FOR THE CURRENT FIELD
      let stateWithRetry = updatedState
      const currentField = detectCurrentField(state)
      const relevantFieldExtracted = isRelevantFieldExtracted(currentField, extracted, state, updatedState)

      if (!relevantFieldExtracted) {
        // Current field wasn't extracted - user response not understood for this question
        stateWithRetry = incrementRetryCount(updatedState, currentField)

        // Show fallback quick replies if retry count >= 1
        if (stateWithRetry.showQuickReplies) {
          const fallbackReplies = getFallbackQuickReplies(currentField, stateWithRetry)
          setQuickReplies(fallbackReplies)
        }
      } else {
        // Successfully extracted relevant field - reset retry
        stateWithRetry = resetRetryCount(updatedState)
        setQuickReplies([])
      }

      // Check if budget was just confirmed (user said yes to budget question)
      if (extracted.budgetAligns === true && state.budgetAligns === null) {
        // User just confirmed budget - show scarcity alert + CTA
        const scarcityAlert: ChatMessage = {
          id: crypto.randomUUID(),
          role: 'agent',
          content: `‚ö†Ô∏è **System Note:** Our High Wycombe/SL4 build-slots for Spring 2026 are currently at **85% capacity**.\n\nDue to current material lead times and our commitment to quality, we have only **3 confirmed start dates** remaining for projects of this scale before June.\n\nTo secure priority on the 'Site Survey' list and lock in your position in the queue, please complete the contact details below immediately.`,
          timestamp: new Date()
        }

        const ctaMessage: ChatMessage = {
          id: crypto.randomUUID(),
          role: 'agent',
          content: `To proceed with this project:\n\n‚Ä¢ **Book a Technical Site Survey**: [Schedule on our calendar](https://calendly.com/pirint-milan/weboldal)\n\n‚Ä¢ **Submit Project Details**: [Complete our contact form](https://landscaletemplate.framer.website/contact#forms)\n\nThis ballpark investment is valid for 14 days due to fluctuating UK material costs.\n\nüìû **Phone:** +1234567898\nüìß **Email:** landscale.agency@gmail.com`,
          timestamp: new Date()
        }

        setState(prev => ({
          ...stateWithRetry,
          messageHistory: [...prev.messageHistory, scarcityAlert, ctaMessage]
        }))
        setIsProcessing(false)
        return
      }

      // Check if budget was declined
      if (extracted.budgetAligns === false && state.budgetAligns === null) {
        // User declined budget - show alternative message
        const alternativeMessage: ChatMessage = {
          id: crypto.randomUUID(),
          role: 'agent',
          content: `I understand. Would you like me to suggest ways to adjust the scope to meet your budget? We can discuss options like:\n\n‚Ä¢ Different material selections\n‚Ä¢ Phased implementation\n‚Ä¢ Reduced project area\n\nAlternatively, you can reach out directly:\n\nüìû **Phone:** +1234567898\nüìß **Email:** landscale.agency@gmail.com`,
          timestamp: new Date()
        }

        setState(prev => ({
          ...stateWithRetry,
          messageHistory: [...prev.messageHistory, alternativeMessage]
        }))
        setIsProcessing(false)
        return
      }

      // Generate acknowledgment
      const ack = generateAcknowledgment(stateWithRetry, extracted)

      // Get next question  
      const nextQ = getNextQuestion(stateWithRetry)

      // Build agent response
      let agentContent = ''
      if (ack) agentContent += ack + ' '

      // Check if ready for estimate
      if (isReadyForEstimate(stateWithRetry) && !nextQ) {
        agentContent += "I now have everything I need to give you a professional ballpark estimate. Let me calculate that for you..."

        const agentMessage: ChatMessage = {
          id: crypto.randomUUID(),
          role: 'agent',
          content: agentContent.trim(),
          timestamp: new Date()
        }

        setState(prev => ({
          ...stateWithRetry,
          messageHistory: [...prev.messageHistory, agentMessage],
          awaitingEstimate: true
        }))

        // Generate estimate
        setTimeout(() => {
          generateEstimate(stateWithRetry)
        }, 1000)

      } else if (nextQ) {
        // Add retry message if showing quick replies
        if (stateWithRetry.showQuickReplies && !ack) {
          agentContent += "Apologies, I want to make sure the math is right for the owner. Could you clarify your response?"
        } else {
          agentContent += nextQ
        }

        const agentMessage: ChatMessage = {
          id: crypto.randomUUID(),
          role: 'agent',
          content: agentContent.trim(),
          timestamp: new Date()
        }

        setState(prev => ({
          ...stateWithRetry,
          messageHistory: [...prev.messageHistory, agentMessage]
        }))
      } else {
        // Fallback
        const agentMessage: ChatMessage = {
          id: crypto.randomUUID(),
          role: 'agent',
          content: ack || "I understand. Could you tell me a bit more?",
          timestamp: new Date()
        }

        setState(prev => ({
          ...stateWithRetry,
          messageHistory: [...prev.messageHistory, agentMessage]
        }))
      }

    } catch (error) {
      console.error('Failed to process message:', error)

      const errorMessage: ChatMessage = {
        id: crypto.randomUUID(),
        role: 'agent',
        content: "Sorry, I had trouble processing that. Could you rephrase?",
        timestamp: new Date()
      }

      setState(prev => ({
        ...prev,
        messageHistory: [...prev.messageHistory, errorMessage]
      }))
    } finally {
      setIsProcessing(false)
    }
  }

  const handleQuickReply = (value: string) => {
    // Simulate user typing the quick reply value
    setInput(value)
    // Trigger form submission programmatically
    handleSend({ preventDefault: () => { } } as React.FormEvent)
  }

  const generateEstimate = (conversationState: ConversationState) => {
    try {
      // Build ProjectInputs from conversation state
      const inputs: ProjectInputs = {
        service: conversationState.service || 'hardscaping',
        hasExcavatorAccess: conversationState.hasExcavatorAccess ?? true,
        hasDrivewayForSkip: conversationState.hasDrivewayForSkip ?? true,
        slopeLevel: conversationState.slopeLevel || 'flat',
        subBaseType: conversationState.subBaseType || 'dirt',
        existingDemolition: conversationState.existingDemolition ?? false,
        length_m: conversationState.length_m || 0,
        width_m: conversationState.width_m || 0,
        area_m2: conversationState.area_m2 || (conversationState.length_m || 0) * (conversationState.width_m || 0),
        materialTier: conversationState.materialTier || 'standard',
        deckHeight_m: conversationState.deckHeight_m || undefined
      }

      const result = calculateUKEstimate(inputs)
      setEstimate(result)

      const estimateMessage: ChatMessage = {
        id: crypto.randomUUID(),
        role: 'estimate',
        content: '', // Content will be rendered separately
        timestamp: new Date()
      }

      // Ask budget alignment question instead of showing CTA immediately
      const budgetQuestion: ChatMessage = {
        id: crypto.randomUUID(),
        role: 'agent',
        content: 'Does this investment align with your budget for this project?',
        timestamp: new Date()
      }

      setState(prev => ({
        ...prev,
        messageHistory: [...prev.messageHistory, estimateMessage, budgetQuestion]
      }))

      // Show budget quick reply options
      setQuickReplies([
        { text: '‚úÖ Yes, that works for me', value: 'yes that works' },
        { text: 'üí≠ Need to discuss scope', value: 'too expensive need to discuss' }
      ])

    } catch (error) {
      console.error('Failed to generate estimate:', error)

      const errorMessage: ChatMessage = {
        id: crypto.randomUUID(),
        role: 'agent',
        content: "I'm having trouble calculating that estimate. Could you verify the project details?",
        timestamp: new Date()
      }

      setState(prev => ({
        ...prev,
        messageHistory: [...prev.messageHistory, errorMessage]
      }))
    }
  }

  return (
    <div className="flex min-h-screen flex-col" style={{ backgroundColor: '#051F20' }}>

      {/* Header */}
      <header className="border-b p-4" style={{ backgroundColor: '#0B2B26', borderColor: '#1A3F3A' }}>
        <div className="mx-auto max-w-4xl">
          <h1 className="text-xl font-bold" style={{ color: '#8EB69B' }}>
            UK Landscape Consultant
          </h1>
          <p className="mt-1 text-sm" style={{ color: '#6B8F7B' }}>
            Senior quantity surveyor | UK 2026 standards
          </p>
        </div>
      </header>

      {/* Messages Area */}
      <div className="flex-1 overflow-y-auto p-4">
        <div className="mx-auto max-w-4xl space-y-4">
          {state.messageHistory.map((message) => {
            if (message.role === 'agent') {
              // Check if this is a scarcity alert message
              const isScarcityAlert = message.content.includes('‚ö†Ô∏è') && message.content.includes('System Note')

              return (
                <div key={message.id} className="flex justify-start">
                  <div
                    className="rounded-2xl p-4 max-w-[80%]"
                    style={{
                      backgroundColor: isScarcityAlert ? '#FFA50020' : '#0B2B26',
                      color: isScarcityAlert ? '#FFD700' : '#DAF1DE',
                      border: isScarcityAlert ? '2px solid #FFA500' : '1px solid #1A3F3A',
                      boxShadow: isScarcityAlert ? '0 0 20px rgba(255, 165, 0, 0.3)' : 'none'
                    }}
                  >
                    <p
                      className="text-sm leading-relaxed whitespace-pre-wrap"
                      dangerouslySetInnerHTML={{
                        __html: message.content.replace(
                          /\[([^\]]+)\]\(([^\)]+)\)/g,
                          '<a href="$2" target="_blank" rel="noopener noreferrer" style="color: #8EB69B; text-decoration: underline;">$1</a>'
                        )
                      }}
                    />
                  </div>
                </div>
              )
            }

            if (message.role === 'user') {
              return (
                <div key={message.id} className="flex justify-end">
                  <div
                    className="rounded-2xl p-4 max-w-[80%]"
                    style={{
                      backgroundColor: '#8EB69B20',
                      color: '#DAF1DE',
                      border: '1px solid #8EB69B'
                    }}
                  >
                    <p className="text-sm leading-relaxed whitespace-pre-wrap">
                      {message.content}
                    </p>
                  </div>
                </div>
              )
            }

            PLACEHOLDER_TEXT
                  </div>

                  {/* Line Items */}
                  <div
                    className="rounded-2xl p-5 mb-4 space-y-3"
                    style={{
                      backgroundColor: '#0B2B26',
                      border: '1px solid #1A3F3A'
                    }}
                  >
                    <p className="text-xs uppercase tracking-wider font-semibold mb-3" style={{ color: '#6B8F7B' }}>
                      Line Items Breakdown
                    </p>
                    {estimate.lineItems.map((item, i) => (
                      <div
                        key={i}
                        className="flex items-start justify-between gap-4 pb-3 border-b"
                        style={{ borderColor: '#1A3F3A' }}
                      >
                        <div className="flex-1">
                          <p className="text-sm font-medium" style={{ color: '#DAF1DE' }}>
                            {item.label}
                          </p>
                          {item.note && (
                            <p className="text-xs mt-1" style={{ color: '#6B8F7B' }}>
                              {item.note}
                            </p>
                          )}
                        </div>
                        <p className="text-sm font-semibold whitespace-nowrap" style={{ color: '#8EB69B' }}>
                          {formatCurrencyGBP(item.amount)}
                        </p>
                      </div>
                    ))}
                  </div>

                  {/* Surveyor's Notes */}
                  <div
                    className="rounded-2xl p-5"
                    style={{
                      backgroundColor: '#1A3F3A',
                      border: '1px solid #8EB69B'
                    }}
                  >
                    <p className="text-xs uppercase tracking-wider font-semibold mb-3" style={{ color: '#8EB69B' }}>
                      Surveyor's Notes
                    </p>
                    <p className="text-sm leading-relaxed" style={{ color: '#DAF1DE' }}>
                      {estimate.reasoning}
                    </p>
                  </div>
                </div>
              )
            }

            return null
          })}

          {/* Typing indicator */}
          {isProcessing && (
            <div className="flex justify-start">
              <div
                className="rounded-2xl px-5 py-3"
                style={{
                  backgroundColor: '#0B2B26',
                  border: '1px solid #1A3F3A'
                }}
              >
                <div className="flex items-center gap-2">
                  <div className="flex gap-1">
                    <div className="w-2 h-2 rounded-full animate-pulse" style={{ backgroundColor: '#8EB69B' }}></div>
                    <div className="w-2 h-2 rounded-full animate-pulse delay-75" style={{ backgroundColor: '#8EB69B' }}></div>
                    <div className="w-2 h-2 rounded-full animate-pulse delay-150" style={{ backgroundColor: '#8EB69B' }}></div>
                  </div>
                  <span className="text-xs" style={{ color: '#6B8F7B' }}>
                    Thinking...
                  </span>
                </div>
              </div>
            </div>
          )}

          <div ref={messagesEndRef} />
        </div>
      </div>

      {/* Input Area */}
      <div
        className="sticky bottom-0 border-t p-4"
        style={{
          backgroundColor: '#0B2B26',
          borderColor: '#1A3F3A'
        }}
      >
        <div className="mx-auto max-w-4xl">
          <form onSubmit={handleSend} className="flex gap-3">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Type your message..."
              disabled={isProcessing}
              className="flex-1 rounded-xl px-5 py-3 text-sm focus:outline-none focus:ring-2"
              style={{
                backgroundColor: '#051F20',
                color: '#DAF1DE',
                border: '1px solid #1A3F3A'
              }}
            />
            <button
              type="submit"
              disabled={isProcessing || !input.trim()}
              className="rounded-xl px-8 py-3 font-medium transition disabled:opacity-50"
              style={{
                backgroundColor: '#8EB69B',
                color: '#051F20'
              }}
            >
              Send
            </button>
          </form>

          {/* Quick Reply Buttons - shown when bot doesn't understand */}
          {state.showQuickReplies && quickReplies.length > 0 && (
            <div className="mt-3 flex flex-wrap gap-2">
              {quickReplies.map((reply, index) => (
                <button
                  key={index}
                  onClick={() => handleQuickReply(reply.value)}
                  disabled={isProcessing}
                  className="quick-reply-btn rounded-lg px-4 py-2 text-sm font-medium transition-all hover:scale-105 disabled:opacity-50"
                  style={{
                    backgroundColor: '#1A3F3A',
                    color: '#DAF1DE',
                    border: '1px solid #8EB69B'
                  }}
                >
                  {reply.text}
                </button>
              ))}
            </div>
          )}

          {/* Certainty indicator */}
          {state.certaintyLevel > 0 && (
            <div className="mt-3 flex items-center gap-2">
              <div className="flex-1 h-1 rounded-full overflow-hidden" style={{ backgroundColor: '#1A3F3A' }}>
                <div
                  className="h-full transition-all duration-500"
                  style={{
                    width: `${state.certaintyLevel}%`,
                    backgroundColor: state.certaintyLevel >= 85 ? '#52A675' : '#8EB69B'
                  }}
                />
              </div>
              <span className="text-xs whitespace-nowrap" style={{ color: '#6B8F7B' }}>
                {state.certaintyLevel}% confident
              </span>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

export default App

